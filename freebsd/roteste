#! /bin/sh -
#
# Scripting helping to automate the FreeBSD CURRENT branch maintenance.

# I've found out that the PORTS_MODULES mechanism does not work well if it is
# not cleaned before running `buildkernel`. The port does not get rebuiled
# resulting in an installation of a port too old for the newly built kernel.
clean_ports_modules() {
    for conf in /etc/src.conf /etc/make.conf
    do
        for module in $(sysrc -f "$conf" PORTS_MODULES)
        do
            cd "/usr/src/$module" && make clean
        done
    done
}

version=0.5.0

if [ $# -eq 0 ]
then
    cat <<__end_of_usage
Usage: roteste [--update]
               [--build-kernel | --build-world | --build | --complete]
               [--install-kernel]
Version: $version
__end_of_usage
elif [ 0 -ne "$(id -u)" ]
then
    echo 'error: roteste has to be run as root' && exit 1
fi

ncpu="$(sysctl -n hw.ncpu)"

set -e

# Get the latest source tree.
case "$*" in
    *--update*)
        if ! [ -d /usr/src/.svn ]
        then
            rm -rf -- /usr/src/*
            svnlite co https://svn.freebsd.org/base/head /usr/src
        else
            svnlite update /usr/src
        fi
        if ! [ -d /usr/ports/.svn ]
        then
            rm -rf -- /usr/ports/*
            svnlite co https://svn.freebsd.org/ports/head /usr/ports
        else
            svnlite update /usr/ports
        fi
        ;;
esac

case "$*" in
    *--build-kernel)
        clean_ports_modules

        cd /usr/src
        kldstat -q -n filemon || kldload filemon
        make -j$ncpu buildkernel
        ;;
    *--build-world)
        cd /usr/src
        kldstat -q -n filemon || kldload filemon
        make -j$ncpu buildworld
        ;;
    *--build*)
        clean_ports_modules

        cd /usr/src
        kldstat -q -n filemon || kldload filemon
        make -j$ncpu buildkernel
        make -j$ncpu buildworld
        ;;
    *--complete*)
        cd /usr/src
        make -j$ncpu installworld
        mergemaster -i -v -U
        ;;
esac

# Install the kernel.
case "$*" in
    *--install-kernel*)
        cd /usr/src
        make -j$ncpu installkernel
        ;;
esac
