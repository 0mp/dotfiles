#! /bin/sh -
#
# Create a wlandev, start a WPA supplicant and run a dhclient.
#
# Version: 2.5

loopmode=no

case "$1" in
    -h|--help)

        cat <<EOF
Usage: ${0##*/} [-l] [wlandev [dev]]

Environmental variables:
    wlandev=wlan0
    dev=iwm0

Send SIGQUIT with Control+\ to reinitiate the connection.
EOF
        exit 0
        ;;
    -l|--loop)
        loopmode=yes
        shift
        ;;
    *)
        ;;
esac

wlandev="${wlandev:-${1:-wlan0}}"
dev="${dev:-${2:-iwm0}}"

sudo sh -c "$(cat <<EOF

reconnect() {
    set -x

    set -u

    if ! ifconfig "$wlandev" >/dev/null 2>&1
    then
        ifconfig "$wlandev" create wlandev "$dev" >/dev/null 2>&1
    else
        service netif restart "$wlandev"
    fi

    ifconfig "$wlandev" up
    wpa_supplicant -B -i "$wlandev" -c /etc/wpa_supplicant.conf
    killall dhclient
    if dhclient "$wlandev"
    then
        { set +x; } 2>/dev/null
        return 0
    else
        { set +x; } 2>/dev/null
        return 1
    fi
}

keep_reconnecting() {
    reconnect
    sleep 1
    while :
    do
        if ifconfig "$wlandev" | grep 'status: associated' >/dev/null 2>&1
        then
            [ "@$loopmode@" = "@no@" ] && break
            sleep 5
        else
            reconnect
        fi
    done
}

trap 'keep_reconnecting' SIGQUIT # It's Ctrl-\.

keep_reconnecting

EOF
)"
