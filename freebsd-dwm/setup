#! /bin/sh -

. ../lib.sh

set -eu

lib_info 'setup'

CUSTOMOPTS="$(opts="${*%--}"; printf -- '%s' "${opts%% -- *}")"
case "$CUSTOMOPTS" in
    *--root-install*)
        lib_require_root
        case $(pkg info --locked dwm 2>/dev/null) in
            *yes) pkg unlock -y dwm ;;
        esac
        cp -f files/patch-fakefullscreen-0mp.diff /usr/ports/x11-wm/dwm/files/
        export DWM_CONF="$PWD/config.h"
        cd /usr/ports/x11-wm/dwm
        make deinstall
        make clean
        make reinstall
        rm -f /usr/ports/x11-wm/dwm/files/patch-fakefullscreen-0mp.diff
        pkg lock -y dwm
        ;;
    *)
        PREFIX="$HOME/.0mp-switch/"
        lib_create_prefix_if_missing

        FILES='eyes-alert.sh fehbg.freebsd-128.png battery-alert.sh status-bar.sh'
        PREFIX="$HOME/.suckless/"
        lib_custom_install() {
            feh -B white --bg-tile ~/.suckless/fehbg.freebsd-128.png
        }
        lib_create_prefix_if_missing
        lib_back_up
        trap lib_roll_back EXIT
        lib_install
        trap - EXIT

        FILES='xinitrc'
        PREFIX=
        lib_custom_install() { :; }
        lib_back_up
        trap lib_roll_back EXIT
        lib_install
        trap - EXIT

        FILES='current-task'
        PREFIX="$HOME/.local/bin/"
        lib_custom_install() { :; }
        lib_create_prefix_if_missing
        lib_back_up
        trap lib_roll_back EXIT
        lib_install
        trap - EXIT
        ;;
esac

lib_info 'setup done'
