#! /bin/sh -
#
# https://wiki.freebsd.org/Laptops/Lenovo_Yoga_3_14

. ../lib.sh

set -eu

lib_info 'setup'

lib_require_root

set_once() {
    filename="$1"
    string="$2"
    if ! grep "$string" "$filename" >/dev/null 2>&1
    then
        printf '%s\n' "$string" >> "$filename"
    fi
}

FILES=
PREFIX=
CUSTOMFILES=
CUSTOMOPTS="$(opts="${@%--}"; printf -- "${opts%% -- *}")"
lib_custom_install() {
    case "$CUSTOMOPTS" in ?*)
        pkg update
    esac

    # Fix the headphones jack.
    set_once '/boot/device.hints' 'hint.hdaa.1.nid22.config="as=1 seq=15"'

    # Disable the power button (https://forums.freebsd.org/threads/56807/).
    set_once '/etc/sysctl.conf' 'hw.acpi.power_button_state=NONE'

    # Disable the console bell.
    set_once '/etc/sysctl.conf' 'kern.vt.enable_bell=0'

    # Enable D-BUS.
    sysrc dbus_enable="YES"

    # Load acpi_video for backlight support.
    sysrc kld_list+=acpi_video

    # Configure Intel drivers.
    # Assume that "/boot/modules" is in the module path.
    # See `sysctl kern.module_path`.
    case "$CUSTOMOPTS" in
        *--intel*) pkg install -y graphics/drm-next-kmod
    esac
    sysrc kld_list+=i915kms

    # Enable moused with some empirically tested flags.
    sysrc moused_enable="YES" moused_flags="-A 1.65 -a 1.1"

    # Configure powerdxx (and disable powerd).
    case "$CUSTOMOPTS" in
        *--powerdxx*) pkg install -y sysutils/powerdxx
    esac
    sysrc powerd_enable=NO
    sysrc powerdxx_enable=YES
    sysrc powerdxx_flags="--ac hiadaptive --batt minimum --unknown adaptive"
    sysrc performance_cx_lowest="Cmax"
    sysrc economy_cx_lowest="Cmax"
}
lib_back_up
trap lib_roll_back EXIT
lib_install
trap - EXIT

lib_info 'setup done'
